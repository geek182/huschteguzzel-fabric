- name: Create Jenkins updates folder.
  file:
    path: /var/lib/jenkins/updates
    owner: jenkins
    group: jenkins
    mode: 0755
    state: directory

- name: Wait untils Jenkins web API is available
  command: curl --head --silent {{ jenkins_base_url }}/
  register: result
  until: result.stdout.find("200 OK") != -1
  retries: 12
  delay: 5
  changed_when: false

- name: Update Jenkins plugin data.
  shell: curl -L {{ jenkins_updatecenter_url }} | sed '1d;$d' > /var/lib/jenkins/updates/default.json
  args:
    creates: /var/lib/jenkins/updates/default.json
  register: update_center
  sudo_user: jenkins

- name: Post updated plugin data to Jenkins.
  command: curl -X POST --data-binary @/var/lib/jenkins/updates/default.json {{ jenkins_base_url }}/updateCenter/byId/default/postBack
  when: update_center|changed

- name: Get list of outdated plugins
  shell: "{{ jenkins_cli_command }} list-plugins | grep -e ')$' | awk '{ print $1 }'"
  register: outdated_plugins
  changed_when: outdated_plugins.stdout_lines

- name: Install additional Jenkins plugins.
  command: "{{ jenkins_cli_command }} install-plugin {{ item }}"
  args:
    creates: /var/lib/jenkins/plugins/{{ item }}.jpi
  with_items: jenkins_plugins
  notify: restart jenkins

- name: Update outdated Jenkins plugins.
  command: "{{ jenkins_cli_command }} install-plugin {{ item }}"
  with_items: outdated_plugins.stdout_lines
  notify: restart jenkins